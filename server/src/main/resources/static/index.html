<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apex Zombie Killer</title>
    <style>
      body { font-family: Inter, system-ui, Arial; margin: 0; padding: 24px; background: #0b1220; color: #dbeafe; }
      h1 { margin: 0 0 8px 0; }
      .card { background: #0f172a; border: 1px solid #1f2937; border-radius: 10px; padding: 16px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      textarea, pre { width: 100%; height: 320px; border-radius: 8px; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      textarea { background: #0b1220; color: #e2e8f0; border: 1px solid #1f2937; }
      pre { background: #111827; color: #e5e7eb; border: 1px solid #1f2937; }
      button, select { height: 36px; border-radius: 8px; border: 1px solid #374151; background: #111827; color: #e5e7eb; padding: 0 10px; cursor: pointer; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .section { margin-top: 16px; }
      .muted { opacity: .8; }
      .chip { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #1f2937; border: 1px solid #374151; font-size: 12px; }
    </style>
  </head>
  <body>
    <h1>Apex Code Transformation Assistant</h1>
    <div class="muted">Paste APEX, select target, and transform. Trigger Heroku jobs below.</div>

    <div class="section card">
      <div class="grid">
        <textarea id="apex" placeholder="Paste Apex code here..."></textarea>
        <pre id="out" placeholder="Output will appear here..."></pre>
      </div>
      <div class="row section">
        <label>Target:</label>
        <select id="target">
          <option value="java">Java (Spring Boot)</option>
          <option value="js">JavaScript (Node)</option>
        </select>
        <button id="btnTransform">Transform</button>
        <span class="chip" id="status"></span>
      </div>
      <div class="section">
        <pre id="notes"></pre>
      </div>
    </div>

    <div class="section card">
      <div class="row">
        <button class="job" data-path="product-purchase">Run ProductPurchase</button>
        <button class="job" data-path="revenue-file-import">Run RevenueFileImport</button>
        <button class="job" data-path="account-plan-reporting">Run AccountPlanReporting</button>
        <button class="job" data-path="cpq-quote-oppty-sync">Run CPQ Quote→Oppty Sync</button>
        <button class="job" data-path="opportunity-split">Run Opportunity Split</button>
      </div>
      <div class="section">
        <pre id="jobOut"></pre>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id)
      const apex = $('apex')
      const out = $('out')
      const notes = $('notes')
      const target = $('target')
      const statusEl = $('status')
      const jobOut = $('jobOut')

      async function transform() {
        statusEl.textContent = 'Working…'
        out.textContent = ''
        notes.textContent = ''
        const body = { apexCode: apex.value, options: { useHerokuConnect: true, generateTests: true } }
        const url = target.value === 'java' ? '/transform/apex-to-java' : '/transform/apex-to-js'
        try {
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
          if (!res.ok) throw new Error('Transform failed')
          const data = await res.json()
          out.textContent = (data.javaCode || data.jsCode || '')
          notes.textContent = (data.notes || '')
          statusEl.textContent = 'Done'
        } catch (e) {
          statusEl.textContent = 'Error'
          notes.textContent = e?.message || 'Error'
        }
      }

      async function runJob(path) {
        statusEl.textContent = 'Enqueuing…'
        jobOut.textContent = ''
        try {
          const res = await fetch(`/jobs/${path}/run`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ batchSize: 1000, maxConcurrency: 4, dryRun: true }) })
          if (!res.ok) throw new Error('Job failed')
          const data = await res.json()
          jobOut.textContent = JSON.stringify(data, null, 2)
          statusEl.textContent = 'Enqueued'
        } catch (e) {
          statusEl.textContent = 'Error'
          jobOut.textContent = e?.message || 'Error'
        }
      }

      document.getElementById('btnTransform').addEventListener('click', transform)
      document.querySelectorAll('.job').forEach(btn => {
        btn.addEventListener('click', () => runJob(btn.dataset.path))
      })
    </script>
  </body>
  </html>



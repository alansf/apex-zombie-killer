<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apex Zombie Killer</title>
    <style>
      /* Palette: Heroku Purple #430098, Teal #00B3CC, neutrals on white */
      body { font-family: Inter, system-ui, Arial; margin: 0; padding: 24px; background: #FFFFFF; color: #181818; }
      h1 { margin: 0 0 8px 0; color: #430098; }
      .card { background: #FFFFFF; border: 1px solid #D8D8D8; border-radius: 10px; padding: 16px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      textarea, pre { width: 100%; height: 320px; border-radius: 8px; padding: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
      textarea { background: #F5F6FA; color: #181818; border: 1px solid #D8D8D8; }
      pre { background: #F9FAFB; color: #181818; border: 1px solid #D8D8D8; }
      button, select { height: 36px; border-radius: 8px; border: 1px solid #D8D8D8; background: #FFFFFF; color: #181818; padding: 0 10px; cursor: pointer; }
      #btnTransform, #btnApprove { background: #430098; border-color: #430098; color: #FFFFFF; }
      #btnTransform:hover, #btnApprove:hover { background: #6F359C; border-color: #6F359C; }
      .job { border-color: #00B3CC; color: #00B3CC; background: #FFFFFF; }
      .job:hover { background: #E6F8FB; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .section { margin-top: 16px; }
      .muted { opacity: .8; }
      .chip { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #E6F8FB; border: 1px solid #00B3CC; color: #004B55; font-size: 12px; }
      #jobOut { border-left: 4px solid #00B3CC; }
    </style>
  </head>
  <body>
    <h1>Apex Code Transformation Assistant</h1>
    <div class="muted">Paste APEX, select target, and transform. Trigger Heroku jobs below.</div>

    <div class="section card">
      <div class="grid">
        <textarea id="apex" placeholder="Paste Apex code here..."></textarea>
        <pre id="out" placeholder="Output will appear here..."></pre>
      </div>
      <div class="row section">
        <label>Target:</label>
        <select id="target">
          <option value="java">Java (Spring Boot)</option>
          <option value="js">JavaScript (Node)</option>
        </select>
        <button id="btnTransform">Transform</button>
        <span class="chip" id="status"></span>
      </div>
      <div class="row section">
        <label>Name:</label>
        <input id="codeName" placeholder="Name for approval (e.g., Demo)" style="height:36px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e2e8f0;padding:0 10px;" />
        <button id="btnApprove">Approve & Publish</button>
      </div>
      <div class="section">
        <pre id="notes"></pre>
      </div>
    </div>

    <div class="section card">
      <div class="row">
        <button class="job" data-path="product-purchase">Run ProductPurchase</button>
        <button class="job" data-path="revenue-file-import">Run RevenueFileImport</button>
        <button class="job" data-path="account-plan-reporting">Run AccountPlanReporting</button>
        <button class="job" data-path="cpq-quote-oppty-sync">Run CPQ Quote→Oppty Sync</button>
        <button class="job" data-path="opportunity-split">Run Opportunity Split</button>
      </div>
      <div class="section">
        <pre id="jobOut"></pre>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id)
      const apex = $('apex')
      const out = $('out')
      const notes = $('notes')
      const target = $('target')
      const statusEl = $('status')
      const jobOut = $('jobOut')
      const codeName = $('codeName')

      async function transform() {
        statusEl.textContent = 'Working…'
        out.textContent = ''
        notes.textContent = ''
        const body = { apexCode: apex.value, options: { useHerokuConnect: true, generateTests: true } }
        const url = target.value === 'java' ? '/transform/apex-to-java' : '/transform/apex-to-js'
        try {
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
          if (!res.ok) throw new Error('Transform failed')
          const data = await res.json()
          out.textContent = (data.javaCode || data.jsCode || '')
          notes.textContent = (data.notes || '')
          statusEl.textContent = 'Done'
        } catch (e) {
          statusEl.textContent = 'Error'
          notes.textContent = e?.message || 'Error'
        }
      }

      async function runJob(path) {
        statusEl.textContent = 'Enqueuing…'
        jobOut.textContent = ''
        try {
          const res = await fetch(`/jobs/${path}/run`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ batchSize: 1000, maxConcurrency: 4, dryRun: true }) })
          if (!res.ok) throw new Error('Job failed')
          const data = await res.json()
          jobOut.textContent = JSON.stringify(data, null, 2)
          statusEl.textContent = 'Enqueued'
        } catch (e) {
          statusEl.textContent = 'Error'
          jobOut.textContent = e?.message || 'Error'
        }
      }

      document.getElementById('btnTransform').addEventListener('click', transform)
      document.querySelectorAll('.job').forEach(btn => {
        btn.addEventListener('click', () => runJob(btn.dataset.path))
      })
      document.getElementById('btnApprove').addEventListener('click', async () => {
        const name = (codeName.value || '').trim()
        if (!name) { notes.textContent = 'Enter a name before approving.'; return }
        if (!out.textContent) { notes.textContent = 'Transform code first.'; return }
        statusEl.textContent = 'Approving…'
        try {
          const res = await fetch('/code/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name,
              language: target.value,
              source: out.textContent,
              metadata: { approvedBy: 'ui', ts: new Date().toISOString() }
            })
          })
          const data = await res.json()
          if (!res.ok) throw new Error(data?.message || 'Approve failed')
          notes.textContent = JSON.stringify(data, null, 2)
          statusEl.textContent = 'Published'
        } catch (e) {
          statusEl.textContent = 'Error'
          notes.textContent = e?.message || 'Approve failed'
        }
      })
    </script>
  </body>
  </html>


